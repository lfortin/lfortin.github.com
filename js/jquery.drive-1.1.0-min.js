/*
 * Drive jQuery plugin v1.1.0
 * http://github.com/lfortin/drive-jquery-plugin#readme
 *
 * Copyright (c) 2009-2010 Laurent Fortin
 * Licensed under the MIT license.
 * http://www.opensource.org/licenses/mit-license.php
 */

(function($){$.extend({DriveClass:function(cfg){this.init(cfg)},_jquerydrive:{options:{selector:'',context:document,defaultTag:'div',inputType:'text',insertMethod:'append',attr:{},css:{},success:function(){},failure:function(){},except:function(){}}},driveOptions:function(options){if(typeof options==='object'){this.extend(this._jquerydrive.options,options)}return this._jquerydrive.options}});$.extend($.DriveClass.prototype,{init:function(cfg){var self=this;self.cfg=cfg||{'$':$};self.$=self.cfg.$||$;self.cfg=self.$.extend({},self.$.driveOptions(),self.cfg);var attr={};self.$.each(self.cfg.attr,function(key,val){if(key.search(/type/i)>-1){self.cfg.inputType=val}else{attr[key]=val}});self.cfg.attr=attr;self.cfg.elements=cfg.elements||self.$(self.cfg.selector,self.cfg.context);self._elements=self.cfg.elements;return self},exec:function(){var self=this;if(!self.cfg.elements.size()){self.tryCatch(function(){self.makeSelectorList().drivePath().runCallback()})}return self},makeSelectorList:function(){var self=this;var selector;if(self.cfg.selector instanceof self.$){selector=self.cfg.selector.selector}else{selector=self.cfg.selector}self.validateSelector(selector);selector=selector.split(',')[0];self._selectorList=self.$.trim(selector).split(' ');return self},validateSelector:function(selector){selector=selector.replace(/\\\[|\\\]|\\\:|\\\*|\\\~|\\\+/,'');if(selector.search(/\[|\]|\:|\*|\~|\+/)>-1){throw('selector must not contain special characters');}return this},drivePath:function(){var self=this;var headContainer;if(self.$(self.cfg.context).size()){var firstNode=self.$(self.cfg.context).get(0);if(firstNode.tagName){headContainer=self.$(firstNode)}else{headContainer=self.$('body')}}else{headContainer=self.$('body')}var selectorAcc=[];var firstCreated;for(var i=0,len=self._selectorList.length;i<len;i++){if(self._selectorList[i]){selectorAcc.push(self._selectorList[i]);if(self._selectorList[i]=='>'){continue}var currentSelector=selectorAcc.join(' ');var currentElements=self.$(currentSelector,self.cfg.context);if(currentElements.size()){headContainer=self.$(currentElements.get(0))}else{var node=self.getNode(self.toObj(self._selectorList[i]));if(self.cfg.showMethod&&!firstCreated){node.css('display','none');firstCreated=node}if(self.cfg.insertMethod=='prepend'){headContainer.prepend(node)}else{headContainer.append(node)}headContainer=node}}}if(self.cfg.showMethod){self.tryCatch(function(){self.runMethod(firstCreated,self.$.makeArray(self.cfg.showMethod))})||firstCreated.show()}self._elements=self.$(self.cfg.selector,self.cfg.context);return self},toObj:function(selector){var self=this;var $=self.$;var obj={};var _match={ID:/#((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,CLASS:/\.((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,TAG:/^((?:[\w\u00c0-\uFFFF\*\-]|\\.)+)/};var _result={};$.each(_match,function(key,val){_result[key]=selector.search(val)});if(_result.CLASS>-1){var classString=selector.substr(_result.CLASS+1);obj._class=classString.split('.');selector=selector.substr(0,selector.length-classString.length-1)}if(_result.ID>-1){var tmp=selector.split('#');obj._id=tmp[1];selector=tmp[0]}if(_result.TAG>-1){obj._tag=selector}else{obj._tag=self.cfg.defaultTag}obj._attr=this.cfg.attr;obj._css=this.cfg.css;return obj},getNode:function(obj){var $=this.$;var inputType=obj._tag.search(/input/i)>-1?(' type="'+this.cfg.inputType+'"'):'';var node=$('<'+obj._tag+inputType+' />');$.each(obj._attr,function(key,val){node.attr(key,val)});if(obj._id){node.attr('id',obj._id)}if(obj._class){for(var i=0,len=obj._class.length;i<len;i++){node.addClass(obj._class[i])}}node.css(obj._css);node.bind('drive:success',this.cfg.success).bind('drive:failure',this.cfg.failure);return node},runMethod:function(elements,args){if(args&&args.length){var _args=[];for(var i=1,len=args.length;i<len;i++){_args.push(args[i])}elements[args[0]].apply(elements,_args)}return this},runCallback:function(){var self=this;var size=self._elements.size();self._elements.trigger((size?'drive:success':'drive:failure'),[self]);return self},tryCatch:function(fn){try{fn()}catch(err){this._elements._jquerydrive_except=this.cfg.except;this._elements._jquerydrive_except(err,this);return false}return true},getElements:function(){return this._elements}});$.extend({drive:function(arg1,arg2,arg3){var cfg={};if(typeof arg1=='object'){cfg=arg1;var elements=$(cfg.selector,cfg.context);$.extend(cfg,{'$':$,'elements':elements})}else{var context=$.isFunction(arg2)?document:arg2;var callback=$.isFunction(arg2)?arg2:arg3;$.extend(cfg,{'selector':arg1,'context':context,'$':$,'elements':$(arg1,context),'success':callback})}return new $.DriveClass(cfg).exec().getElements()}});if($('#_selector_test').selector){$.fn.extend({drive:function(arg1){if(this.selector){var cfg={};if($.isFunction(arg1)){cfg.success=arg1}else if(typeof arg1=='string'){cfg.showMethod=arguments}else if(typeof arg1=='object'){cfg=arg1}$.extend(cfg,{'selector':this.selector,'context':this.context,'$':$,'elements':this});return new $.DriveClass(cfg).exec().getElements()}return this}})}})(jQuery);